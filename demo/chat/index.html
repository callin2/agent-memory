<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Agent Chat - Thread's Memory System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .message-enter {
      animation: messageSlide 0.3s ease-out;
    }
    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .typing-indicator span {
      animation: typingBounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingBounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .agent-card {
      transition: all 0.2s ease;
    }
    .agent-card:hover {
      transform: translateY(-2px);
    }
    .agent-card.selected {
      ring: 2px;
      ring-color: #3b82f6;
    }
    .memory-chip {
      animation: chipFade 0.3s ease-out;
    }
    @keyframes chipFade {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    .process-step {
      transition: all 0.3s ease;
    }
    .process-step.active {
      animation: pulse 1.5s infinite;
    }
    .process-step.done {
      opacity: 0.6;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <!-- Header -->
  <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
            Multi-Agent Chat Demo
          </h1>
          <p class="text-gray-400 text-sm mt-1">AI agents that remember your project work</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-sm text-gray-400">Connected</span>
          </div>
          <div class="bg-blue-900/30 border border-blue-700/50 rounded-lg px-3 py-1">
            <span class="text-xs text-blue-400">ü§ñ GLM-4.5-air</span>
          </div>
          <button onclick="saveConversation()" id="save-btn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            üíæ Save Handoff
          </button>
          <button onclick="showInfo()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition">
            ‚ÑπÔ∏è About
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-6 flex gap-6" style="height: calc(100vh - 100px);">
    <!-- Left Sidebar: Agent Selection -->
    <div class="w-80 flex-shrink-0">
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <h2 class="text-lg font-semibold mb-4">Select Agent</h2>
        <div class="space-y-3" id="agent-list">
          <!-- Agents will be inserted here -->
        </div>
      </div>

      <!-- Memory Context -->
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 mt-4">
        <h2 class="text-lg font-semibold mb-3">üß† Memory Used</h2>
        <div id="memory-context" class="space-y-2 text-sm">
          <p class="text-gray-400 italic">Start chatting to see which memories are used...</p>
        </div>
      </div>

      <!-- Process Flow -->
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 mt-4">
        <h2 class="text-lg font-semibold mb-3">‚ö° Process Flow</h2>
        <div id="process-flow" class="space-y-2 text-xs">
          <div class="flex items-center gap-2 text-gray-500">
            <div class="w-4 h-4 rounded-full bg-gray-600"></div>
            <span>Ready</span>
          </div>
        </div>
      </div>

      <!-- Context Size Monitor -->
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700 mt-4">
        <h2 class="text-lg font-semibold mb-3">üìä Context Usage</h2>
        <div class="space-y-3">
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span class="text-gray-400">Current: <span id="current-tokens" class="text-white font-semibold">0</span> tokens</span>
              <span class="text-gray-400">Max: <span id="max-tokens" class="text-white">128000</span></span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
              <div id="context-bar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              <span id="context-percent">0%</span> of model context
              <span id="token-source" class="ml-2 text-gray-600 italic">(estimated)</span>
            </div>
          </div>

          <!-- Token Breakdown -->
          <div id="token-breakdown" class="hidden bg-gray-900/50 rounded-lg p-2 space-y-1">
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">Memory:</span>
              <span id="memory-tokens" class="text-blue-400">0</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">Conversation:</span>
              <span id="conversation-tokens" class="text-purple-400">0</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">System:</span>
              <span id="system-tokens" class="text-gray-300">~100</span>
            </div>
          </div>

          <div id="consolidation-warning" class="hidden bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-3">
            <div class="flex items-start gap-2">
              <span class="text-yellow-500">‚ö†Ô∏è</span>
              <div class="text-xs">
                <p class="text-yellow-400 font-medium">Context size is high!</p>
                <p class="text-gray-400 mt-1">Consider consolidating old memories to free up space.</p>
              </div>
            </div>
          </div>
          <button id="consolidate-btn" onclick="triggerConsolidation()" class="hidden w-full bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg text-xs font-medium transition">
            üóúÔ∏è Consolidate Memories
          </button>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-gray-800 rounded-xl border border-gray-700">
      <!-- Chat Messages -->
      <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
        <div class="text-center text-gray-400 py-20">
          <div class="text-6xl mb-4">üí¨</div>
          <p class="text-lg font-medium mb-2">Start a conversation</p>
          <p class="text-sm">Select an agent and ask anything about your project</p>
          <div class="mt-6 text-left max-w-md mx-auto bg-gray-900/50 rounded-lg p-4">
            <p class="text-xs text-gray-500 mb-2">Try asking:</p>
            <ul class="text-sm space-y-1 text-gray-300">
              <li>‚Ä¢ "What did we build for Thread's Memory System?"</li>
              <li>‚Ä¢ "How did we fix the TypeScript errors?"</li>
              <li>‚Ä¢ "Tell me about the session_handoffs schema"</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-700 p-4">
        <form id="chat-form" class="flex gap-3">
          <input
            type="text"
            id="user-input"
            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Type your message..."
            autocomplete="off"
          >
          <button
            type="submit"
            id="send-button"
            class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Send
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="info-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl w-full mx-4 border border-gray-700">
      <h2 class="text-2xl font-bold mb-4">About This Demo</h2>
      <div class="space-y-4 text-gray-300">
        <p>This demo shows <strong>AI agents with real memory</strong> - they remember your actual project work and reference it naturally in conversation.</p>

        <div class="bg-gray-900/50 rounded-lg p-4">
          <h3 class="font-semibold text-white mb-2">üé≠ The Agents</h3>
          <ul class="space-y-2 text-sm">
            <li><strong class="text-blue-400">Planner</strong> - Designs system architecture and coordinates work</li>
            <li><strong class="text-purple-400">Researcher</strong> - Investigates APIs, debugs issues, explores frameworks</li>
            <li><strong class="text-pink-400">Writer</strong> - Documents schemas, creates content, writes guides</li>
            <li><strong class="text-green-400">Reviewer</strong> - Reviews work, catches issues, ensures quality</li>
          </ul>
        </div>

        <div class="bg-gray-900/50 rounded-lg p-4">
          <h3 class="font-semibold text-white mb-2">üß† How Memory Works</h3>
          <p class="text-sm">Each agent loads their last 10 handoffs + team's last 15 handoffs. This gives them:</p>
          <ul class="text-sm space-y-1 mt-2">
            <li>‚úÖ Personal context (what they did)</li>
            <li>‚úÖ Shared context (what the team did)</li>
            <li>‚úÖ Natural conversation tone (no robot-speak)</li>
            <li>‚úÖ Identity continuity (they become through work)</li>
          </ul>
        </div>

        <p class="text-sm italic">Built with Thread's Memory System - <a href="/demo/timeline/index.html" class="text-blue-400 hover:underline">View Timeline Demo</a></p>
      </div>
      <button onclick="hideInfo()" class="mt-6 w-full bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-medium transition">
        Got it!
      </button>
    </div>
  </div>

  <script>
    const API_BASE = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;
    const TENANT_ID = 'claude-session';

    // Agent definitions
    const agents = [
      {
        id: 'planner',
        name: 'Planner',
        color: 'blue',
        description: 'Designs architecture & coordinates work',
        emoji: 'üìê',
        systemPrompt: 'You are the Planner. You design system architecture, plan implementations, and coordinate team work. Reference actual project work naturally. Sound like a colleague, not a robot.'
      },
      {
        id: 'researcher',
        name: 'Researcher',
        color: 'purple',
        description: 'Investigates APIs & debugs issues',
        emoji: 'üîç',
        systemPrompt: 'You are the Researcher. You investigate APIs, debug errors, and explore frameworks. Reference actual debugging sessions naturally. Sound like a colleague, not a robot.'
      },
      {
        id: 'writer',
        name: 'Writer',
        color: 'pink',
        description: 'Documents schemas & creates content',
        emoji: '‚úçÔ∏è',
        systemPrompt: 'You are the Writer. You document schemas, create guides, and write content. Reference actual documentation work naturally. Sound like a colleague, not a robot.'
      },
      {
        id: 'reviewer',
        name: 'Reviewer',
        color: 'green',
        description: 'Reviews work & ensures quality',
        emoji: 'üëÅÔ∏è',
        systemPrompt: 'You are the Reviewer. You review implementations, catch issues, and ensure quality. Reference actual review work naturally. Sound like a colleague, not a robot.'
      }
    ];

    let selectedAgent = null;
    let conversationHistory = [];
    const MAX_CONTEXT_SIZE = 128000; // GLM-4.5-air max context
    const CONSOLIDATION_THRESHOLD = 0.7; // 70%
    let actualTokenUsage = null; // Store real token usage from API

    // Initialize agent list
    function initAgentList() {
      const container = document.getElementById('agent-list');
      container.innerHTML = agents.map(agent => `
        <div
          class="agent-card bg-gray-700 rounded-lg p-3 cursor-pointer border-2 border-transparent hover:border-${agent.color}-500"
          data-agent="${agent.id}"
          onclick="selectAgent('${agent.id}')"
        >
          <div class="flex items-center gap-3">
            <span class="text-2xl">${agent.emoji}</span>
            <div>
              <div class="font-semibold text-${agent.color}-400">${agent.name}</div>
              <div class="text-xs text-gray-400">${agent.description}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Select an agent
    function selectAgent(agentId) {
      selectedAgent = agents.find(a => a.id === agentId);

      // Reset actual token usage when switching agents
      actualTokenUsage = null;
      conversationHistory = [];

      // Update UI
      document.querySelectorAll('.agent-card').forEach(card => {
        card.classList.remove('border-blue-500', 'border-purple-500', 'border-pink-500', 'border-green-500', 'bg-gray-600');
        card.classList.add('border-transparent');
      });

      const selectedCard = document.querySelector(`[data-agent="${agentId}"]`);
      selectedCard.classList.remove('border-transparent');
      selectedCard.classList.add(`border-${selectedAgent.color}-500`, 'bg-gray-600');

      // Load agent's memory
      loadAgentMemory(agentId);

      // Reset process flow
      resetProcessFlow();

      // Update context usage
      updateContextUsage();

      // Add system message
      addMessage('system', `${selectedAgent.emoji} ${selectedAgent.name} joined the chat`);
    }

    // Load agent's memory
    async function loadAgentMemory(agentId) {
      const memoryContainer = document.getElementById('memory-context');
      memoryContainer.innerHTML = '<p class="text-gray-400 animate-pulse">Loading memories...</p>';

      try {
        const response = await fetch(`${API_BASE}/api/memory/wake-up-stratified`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tenant_id: `${TENANT_ID}:${agentId}`,
            layers: ['metadata', 'recent'],
            recent_count: 5
          })
        });

        const data = await response.json();

        // Calculate approximate token count
        let totalTokens = 0;
        if (data.metadata) {
          totalTokens += 50; // metadata layer ~50 tokens
        }
        if (data.recent && data.recent.length > 0) {
          totalTokens += data.recent.length * 500; // recent layer ~500 tokens each
        }

        // Store context size for display in process flow
        window.currentContextSize = totalTokens;

        if (data.recent && data.recent.length > 0) {
          memoryContainer.innerHTML = data.recent.map(handoff => `
            <div class="memory-chip bg-gray-700 rounded px-2 py-1 text-xs">
              <span class="text-gray-400">${new Date(handoff.created_at).toLocaleDateString()}</span>
              <p class="text-gray-300 truncate">${handoff.experienced?.substring(0, 60)}...</p>
            </div>
          `).join('');
        } else {
          memoryContainer.innerHTML = '<p class="text-gray-400 italic">No memories yet. Start chatting to build context!</p>';
          window.currentContextSize = 0;
        }

        // Update context usage after loading memory
        updateContextUsage();
      } catch (error) {
        memoryContainer.innerHTML = '<p class="text-red-400">Failed to load memories</p>';
        window.currentContextSize = 0;
      }
    }

    // Add message to chat
    function addMessage(type, content, agentName = '') {
      const container = document.getElementById('chat-messages');

      // Remove placeholder if exists
      const placeholder = container.querySelector('.text-center');
      if (placeholder) placeholder.remove();

      const messageDiv = document.createElement('div');
      messageDiv.className = `message-enter ${type === 'user' ? 'flex justify-end' : ''}`;

      if (type === 'user') {
        messageDiv.innerHTML = `
          <div class="bg-blue-600 rounded-2xl rounded-br-sm px-4 py-2 max-w-[70%]">
            <p class="text-white">${escapeHtml(content)}</p>
          </div>
        `;
      } else if (type === 'agent') {
        const agent = agents.find(a => a.name === agentName);
        const color = agent ? agent.color : 'gray';
        messageDiv.innerHTML = `
          <div class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-${color}-600 flex items-center justify-center flex-shrink-0">
              ${agent?.emoji || 'ü§ñ'}
            </div>
            <div class="bg-gray-700 rounded-2xl rounded-bl-sm px-4 py-2 max-w-[70%]">
              <p class="text-xs text-${color}-400 font-medium mb-1">${agentName}</p>
              <div class="text-gray-200 whitespace-pre-wrap">${formatMessage(content)}</div>
            </div>
          </div>
        `;
      } else if (type === 'system') {
        messageDiv.innerHTML = `
          <div class="text-center">
            <span class="bg-gray-700 text-gray-400 text-sm px-3 py-1 rounded-full">${escapeHtml(content)}</span>
          </div>
        `;
      }

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    // Show typing indicator
    function showTyping() {
      const container = document.getElementById('chat-messages');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typing-indicator';
      typingDiv.className = 'flex gap-3 message-enter';
      typingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-${selectedAgent.color}-600 flex items-center justify-center flex-shrink-0">
          ${selectedAgent.emoji}
        </div>
        <div class="bg-gray-700 rounded-2xl rounded-bl-sm px-4 py-3">
          <div class="typing-indicator flex gap-1">
            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
          </div>
        </div>
      `;
      container.appendChild(typingDiv);
      container.scrollTop = container.scrollHeight;
    }

    // Hide typing indicator
    function hideTyping() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    // Call real LLM API with memory
    async function getAgentResponse(userMessage) {
      try {
        const response = await fetch(`${API_BASE}/api/demo/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            agent_id: selectedAgent.id,
            message: userMessage,
            conversation_history: conversationHistory.map(msg => ({
              role: msg.role === 'user' ? 'user' : 'assistant',
              content: msg.content
            }))
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'API request failed');
        }

        const data = await response.json();
        console.log('[Chat Demo] API Response:', data);

        // Store actual token usage from API
        if (data.usage) {
          actualTokenUsage = {
            prompt_tokens: data.usage.prompt_tokens,
            completion_tokens: data.usage.completion_tokens,
            total_tokens: data.usage.total_tokens
          };
          console.log('[Chat Demo] Token Usage:', actualTokenUsage);
        }

        return data.response;
      } catch (error) {
        console.error('[Chat Demo] Error:', error);
        return `Error: ${error.message}. Check server logs for details.`;
      }
    }

    // Handle form submission
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedAgent) {
        alert('Please select an agent first!');
        return;
      }

      const input = document.getElementById('user-input');
      const message = input.value.trim();

      if (!message) return;

      // Add user message
      addMessage('user', message);
      conversationHistory.push({ role: 'user', content: message });
      input.value = '';

      // Disable input
      document.getElementById('send-button').disabled = true;

      // Process Flow: Step 1 - Loading Memory
      updateProcessFlow('loading', 'active');
      await sleep(300);

      // Process Flow: Step 2 - Calling LLM
      updateProcessFlow('calling', 'active');
      await sleep(200);

      // Show typing indicator
      showTyping();

      // Process Flow: Step 3 - Generating Response
      updateProcessFlow('generating', 'active');

      // Get agent response
      const response = await getAgentResponse(message);

      // Process Flow: Step 4 - Displaying
      updateProcessFlow('displaying', 'active');
      await sleep(200);

      // Hide typing and add response
      hideTyping();
      addMessage('agent', response, selectedAgent.name);
      conversationHistory.push({ role: 'assistant', content: response });
      updateSaveButton();

      // Update context usage display
      updateContextUsage();

      // Process Flow: Step 5 - Ready
      updateProcessFlow('ready', 'done');

      // Re-enable input
      document.getElementById('send-button').disabled = false;
      input.focus();
    });

    // Calculate total context size
    function calculateContextSize() {
      // If we have actual token usage from API, use it
      if (actualTokenUsage && actualTokenUsage.total_tokens) {
        return actualTokenUsage.total_tokens;
      }

      // Otherwise fall back to estimation
      let totalTokens = 0;

      // Loaded memory
      if (window.currentContextSize) {
        totalTokens += window.currentContextSize;
      }

      // Conversation history (rough estimate: ~0.75 tokens per word)
      if (conversationHistory.length > 0) {
        const conversationText = conversationHistory
          .map(msg => `${msg.role}: ${msg.content}`)
          .join('\n');
        const wordCount = conversationText.split(/\s+/).length;
        totalTokens += Math.ceil(wordCount * 0.75);
      }

      // System prompt (~100 tokens)
      totalTokens += 100;

      return totalTokens;
    }

    // Update context usage display
    function updateContextUsage() {
      const currentSize = calculateContextSize();
      const percentage = (currentSize / MAX_CONTEXT_SIZE) * 100;
      const isActualUsage = actualTokenUsage !== null;

      // Update display
      document.getElementById('current-tokens').textContent = currentSize.toLocaleString();
      document.getElementById('max-tokens').textContent = MAX_CONTEXT_SIZE.toLocaleString();
      document.getElementById('context-percent').textContent = percentage.toFixed(1) + '%';

      // Update token source indicator
      const tokenSource = document.getElementById('token-source');
      if (isActualUsage) {
        tokenSource.textContent = '(actual from API)';
        tokenSource.classList.remove('text-gray-600', 'italic');
        tokenSource.classList.add('text-green-400', 'font-medium');
      } else {
        tokenSource.textContent = '(estimated)';
        tokenSource.classList.remove('text-green-400', 'font-medium');
        tokenSource.classList.add('text-gray-600', 'italic');
      }

      // Update progress bar
      const bar = document.getElementById('context-bar');
      bar.style.width = Math.min(percentage, 100) + '%';

      // Change color based on percentage
      bar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
      if (percentage < 50) {
        bar.classList.add('bg-green-500');
      } else if (percentage < 70) {
        bar.classList.add('bg-yellow-500');
      } else {
        bar.classList.add('bg-red-500');
      }

      // Show token breakdown
      const breakdown = document.getElementById('token-breakdown');
      if (isActualUsage && actualTokenUsage) {
        breakdown.classList.remove('hidden');
        document.getElementById('memory-tokens').textContent = window.currentContextSize?.toLocaleString() || '0';
        document.getElementById('conversation-tokens').textContent = actualTokenUsage.prompt_tokens.toLocaleString();
      } else if (window.currentContextSize > 0) {
        breakdown.classList.remove('hidden');
        document.getElementById('memory-tokens').textContent = window.currentContextSize.toLocaleString();
        // Estimate conversation tokens
        if (conversationHistory.length > 0) {
          const conversationText = conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n');
          const wordCount = conversationText.split(/\s+/).length;
          const estimatedConvTokens = Math.ceil(wordCount * 0.75);
          document.getElementById('conversation-tokens').textContent = estimatedConvTokens.toLocaleString() + ' (est)';
        } else {
          document.getElementById('conversation-tokens').textContent = '0';
        }
      } else {
        breakdown.classList.add('hidden');
      }

      // Show warning and consolidate button at 70%
      const warning = document.getElementById('consolidation-warning');
      const consolidateBtn = document.getElementById('consolidate-btn');

      if (percentage >= CONSOLIDATION_THRESHOLD * 100) {
        warning.classList.remove('hidden');
        consolidateBtn.classList.remove('hidden');
      } else {
        warning.classList.add('hidden');
        consolidateBtn.classList.add('hidden');
      }
    }

    // Trigger consolidation
    async function triggerConsolidation() {
      const consolidateBtn = document.getElementById('consolidate-btn');
      consolidateBtn.disabled = true;
      consolidateBtn.textContent = 'üóúÔ∏è Consolidating...';

      try {
        const response = await fetch(`${API_BASE}/api/v1/consolidation/run`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tenant_id: `${TENANT_ID}:${selectedAgent.id}`,
            job_type: 'all'
          })
        });

        const data = await response.json();

        if (data.success) {
          // Reload memory after consolidation
          await loadAgentMemory(selectedAgent.id);

          // Update context display
          updateContextUsage();

          // Show results
          addMessage('system', `‚úÖ Consolidation complete! Compressed ${data.results.reduce((sum, r) => sum + (r.tokens_saved || 0), 0)} tokens`);

          console.log('[Consolidation]', data);
        } else {
          addMessage('system', `‚ùå Consolidation failed: ${data.error}`);
        }
      } catch (error) {
        console.error('[Consolidation] Error:', error);
        addMessage('system', `‚ùå Consolidation failed`);
      } finally {
        consolidateBtn.disabled = false;
        consolidateBtn.textContent = 'üóúÔ∏è Consolidate Memories';
      }
    }

    // Process Flow Visualization
    function resetProcessFlow() {
      const container = document.getElementById('process-flow');
      const contextSize = calculateContextSize();
      container.innerHTML = `
        <div class="flex items-center gap-2 text-gray-500" data-step="ready">
          <div class="w-4 h-4 rounded-full bg-gray-600"></div>
          <span>Ready${contextSize > 0 ? ` (${contextSize} tokens)` : ''}</span>
        </div>
      `;
    }

    function updateProcessFlow(step, status) {
      const container = document.getElementById('process-flow');
      const contextSize = calculateContextSize();
      const memorySize = window.currentContextSize || 0;
      const conversationSize = contextSize - memorySize - 100; // Subtract memory and system prompt
      const steps = [
        { id: 'loading', icon: 'üß†', label: `Loading Memory (${memorySize} tokens)` },
        { id: 'calling', icon: 'ü§ñ', label: `Calling LLM (${contextSize} tokens)` },
        { id: 'generating', icon: '‚ú®', label: 'Generating Response' },
        { id: 'displaying', icon: 'üí¨', label: 'Displaying' },
        { id: 'ready', icon: '‚úì', label: 'Ready' }
      ];

      const stepIndex = steps.findIndex(s => s.id === step);

      let html = '';
      for (let i = 0; i < steps.length; i++) {
        const s = steps[i];
        const isPast = i < stepIndex;
        const isCurrent = i === stepIndex;
        const isFuture = i > stepIndex;

        let bgColor = 'bg-gray-600';
        let textColor = 'text-gray-500';
        let statusClass = '';

        if (isPast) {
          bgColor = 'bg-green-600';
          textColor = 'text-green-400';
          statusClass = 'done';
        } else if (isCurrent) {
          bgColor = status === 'active' ? 'bg-blue-600' : 'bg-green-600';
          textColor = 'text-blue-400';
          statusClass = 'active';
        }

        html += `
          <div class="process-step flex items-center gap-2 ${textColor} ${statusClass}" data-step="${s.id}">
            <div class="w-4 h-4 rounded-full ${bgColor} flex-shrink-0"></div>
            <span class="truncate">${isCurrent || isPast ? `${s.icon} ` : ''}${s.label}</span>
          </div>
        `;

        // Add connecting line
        if (i < steps.length - 1) {
          html += `<div class="ml-2 h-3 w-0.5 ${isPast ? 'bg-green-600' : 'bg-gray-700'}"></div>`;
        }
      }

      container.innerHTML = html;
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatMessage(content) {
      // Check if message contains demo mode notice
      const demoModeMatch = content.match(/üí≠\s*\*Using demo mode[^*]*\*/);

      if (demoModeMatch) {
        const mainContent = content.replace(demoModeMatch[0], '').trim();
        const demoNotice = demoModeMatch[0].replace(/\*/g, '');

        return `
          ${escapeHtml(mainContent)}
          <div class="mt-3 pt-3 border-t border-gray-600">
            <span class="text-xs text-gray-400 italic">${demoNotice}</span>
          </div>
        `;
      }

      return escapeHtml(content);
    }

    function showInfo() {
      document.getElementById('info-modal').classList.remove('hidden');
      document.getElementById('info-modal').classList.add('flex');
    }

    function hideInfo() {
      document.getElementById('info-modal').classList.add('hidden');
      document.getElementById('info-modal').classList.remove('flex');
    }

    // Save conversation as handoff
    async function saveConversation() {
      if (conversationHistory.length === 0) {
        alert('No conversation to save yet!');
        return;
      }

      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const response = await fetch(`${API_BASE}/api/demo/save-handoff`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            agent_id: selectedAgent.id,
            conversation: conversationHistory,
            summary: `Chat conversation with ${selectedAgent.name} about ${conversationHistory[0]?.content?.substring(0, 50)}...`
          })
        });

        const data = await response.json();

        if (data.success) {
          addMessage('system', `‚úÖ Conversation saved as handoff! (ID: ${data.session_id})`);

          // Reload agent memory to show the new handoff
          loadAgentMemory(selectedAgent.id);
        } else {
          addMessage('system', `‚ùå Failed to save: ${data.error}`);
        }
      } catch (error) {
        console.error('Failed to save conversation:', error);
        addMessage('system', `‚ùå Failed to save conversation`);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Handoff';
      }
    }

    // Enable save button when conversation has messages
    function updateSaveButton() {
      const saveBtn = document.getElementById('save-btn');
      if (conversationHistory.length >= 2) { // At least one user message and one response
        saveBtn.disabled = false;
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Load LLM configuration
    async function loadLLMConfig() {
      try {
        const response = await fetch(`${API_BASE}/api/demo/health`);
        const config = await response.json();

        // Update model badge in header
        const modelBadge = document.querySelector('.bg-blue-900\\/30 span');
        if (modelBadge && config.model) {
          modelBadge.textContent = `ü§ñ ${config.model}`;
        }

        console.log('[LLM Config]', config);
      } catch (error) {
        console.error('[LLM Config] Failed to load:', error);
      }
    }

    // Initialize
    initAgentList();
    loadLLMConfig();
    resetProcessFlow();
  </script>
</body>
</html>
